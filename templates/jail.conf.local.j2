#
# WARNING: heavily refactored in 0.9.0 release.  Please review and
#          customize settings for your setup.
#
# Changes:  in most of the cases you should not modify this
#           file, but provide customizations in jail.local file,
#           or separate .conf files under jail.d/ directory, e.g.:
#
# HOW TO ACTIVATE JAILS:
#
# YOU SHOULD NOT MODIFY THIS FILE.
#
# It will probably be overwritten or improved in a distribution update.
#
# Provide customizations in a jail.local file or a jail.d/customisation.local.
# For example to change the default bantime for all jails and to enable the
# ssh-iptables jail the following (uncommented) would appear in the .local file.
# See man 5 jail.conf for details.
#
# [DEFAULT]
# bantime = 1h
#
# [sshd]
# enabled = true
#
# See jail.conf(5) man page for more information



# Comments: use '#' for comment lines and ';' (following a space) for inline comments


[INCLUDES]

#before = paths-distro.conf
before = {{ fail2ban_before|default(fail2ban_default_before) }}

# The DEFAULT allows a global definition of the options. They can be overridden
# in each jail afterwards.

[DEFAULT]

#
# MISCELLANEOUS OPTIONS
#

# "bantime.increment" allows to use database for searching of previously banned ip's to increase a
# default ban time using special formula, default it is banTime * 1, 2, 4, 8, 16, 32...
bantime.increment = {{ fail2ban_bantime_increment|default(fail2ban_default_bantime_increment)|string|lower }}

# "bantime.rndtime" is the max number of seconds using for mixing with random time
# to prevent "clever" botnets calculate exact time IP can be unbanned again:
bantime.rndtime = {{ fail2ban_bantime_rndtime|default(fail2ban_default_bantime_rndtime) }}

# "bantime.maxtime" is the max number of seconds using the ban time can reach (doesn't grow further)
bantime.maxtime = {{ fail2ban_bantime_maxtime|default(fail2ban_default_bantime_maxtime) }}

# "bantime.factor" is a coefficient to calculate exponent growing of the formula or common multiplier,
# default value of factor is 1 and with default value of formula, the ban time
# grows by 1, 2, 4, 8, 16 ...
bantime.factor = {{ fail2ban_bantime_factor|default(fail2ban_default_bantime_factor) }}

# "bantime.formula" used by default to calculate next value of ban time, default value below,
# the same ban time growing will be reached by multipliers 1, 2, 4, 8, 16, 32...
#bantime.formula = ban.Time * (1<<(ban.Count if ban.Count<20 else 20)) * banFactor
#
# more aggressive example of formula has the same values only for factor "2.0 / 2.885385" :
bantime.formula = {{ fail2ban_bantime_formula|default(fail2ban_default_bantime_formula) }}

# "bantime.multipliers" used to calculate next value of ban time instead of formula, coresponding
# previously ban count and given "bantime.factor" (for multipliers default is 1);
# following example grows ban time by 1, 2, 4, 8, 16 ... and if last ban count greater as multipliers count,
# always used last multiplier (64 in example), for factor '1' and original ban time 600 - 10.6 hours
#bantime.multipliers = 1 2 4 8 16 32 64
# following example can be used for small initial ban time (bantime=60) - it grows more aggressive at begin,
# for bantime=60 the multipliers are minutes and equal: 1 min, 5 min, 30 min, 1 hour, 5 hour, 12 hour, 1 day, 2 day
bantime.multipliers = {{ fail2ban_bantime_multipliers|default(fail2ban_default_bantime_multipliers)|join(' ') }}

# "bantime.overalljails" (if true) specifies the search of IP in the database will be executed
# cross over all jails, if false (dafault), only current jail of the ban IP will be searched
bantime.overalljails = {{ fail2ban_bantime_overalljails|default(fail2ban_default_bantime_overalljails)|string|lower }}

# --------------------

# "ignoreself" specifies whether the local resp. own IP addresses should be ignored
# (default is true). Fail2ban will not ban a host which matches such addresses.
ignoreself = {{ fail2ban_bantime_ignoreself|default(fail2ban_default_bantime_ignoreself)|string|lower }}

# "ignoreip" can be a list of IP addresses, CIDR masks or DNS hosts. Fail2ban
# will not ban a host which matches an address in this list. Several addresses
# can be defined using space (and/or comma) separator.
ignoreip = {{ fail2ban_ignoreip|default(fail2ban_default_ignoreip)|join(' ') }}

# External command that will take an tagged arguments to ignore, e.g. <ip>,
# and return true if the IP is to be ignored. False otherwise.
#
# ignorecommand = /path/to/command <ip>
ignorecommand = {{ fail2ban_ignorecommand|default(fail2ban_default_ignorecommand) }}

# "bantime" is the number of seconds that a host is banned.
bantime  = {{ fail2ban_bantime|default(fail2ban_default_bantime) }}

# A host is banned if it has generated "maxretry" during the last "findtime"
# seconds.
findtime  = {{ fail2ban_findtime|default(fail2ban_default_findtime) }}

# "maxretry" is the number of failures before a host get banned.
maxretry = {{ fail2ban_maxretry|default(fail2ban_default_maxretry) }}

# "maxmatches" is the number of matches stored in ticket (resolvable via tag <matches> in actions).
maxmatches = {{ fail2ban_maxmatches|default(fail2ban_default_maxmatches) }}

# "backend" specifies the backend used to get files modification.
# Available options are "pyinotify", "gamin", "polling", "systemd" and "auto".
# This option can be overridden in each jail as well.
#
# pyinotify: requires pyinotify (a file alteration monitor) to be installed.
#              If pyinotify is not installed, Fail2ban will use auto.
# gamin:     requires Gamin (a file alteration monitor) to be installed.
#              If Gamin is not installed, Fail2ban will use auto.
# polling:   uses a polling algorithm which does not require external libraries.
# systemd:   uses systemd python library to access the systemd journal.
#              Specifying "logpath" is not valid for this backend.
#              See "journalmatch" in the jails associated filter config
# auto:      will try to use the following backends, in order:
#              pyinotify, gamin, polling.
#
# Note: if systemd backend is chosen as the default but you enable a jail
#       for which logs are present only in its own log files, specify some other
#       backend for that jail (e.g. polling) and provide empty value for
#       journalmatch. See https://github.com/fail2ban/fail2ban/issues/959#issuecomment-74901200
backend = {{ fail2ban_backend|default(fail2ban_default_backend) }}

# "usedns" specifies if jails should trust hostnames in logs,
#   warn when DNS lookups are performed, or ignore all hostnames in logs
#
# yes:   if a hostname is encountered, a DNS lookup will be performed.
# warn:  if a hostname is encountered, a DNS lookup will be performed,
#        but it will be logged as a warning.
# no:    if a hostname is encountered, will not be used for banning,
#        but it will be logged as info.
# raw:   use raw value (no hostname), allow use it for no-host filters/actions (example user)
usedns = {{ fail2ban_usedns|default(fail2ban_default_usedns) }}

# "logencoding" specifies the encoding of the log files handled by the jail
#   This is used to decode the lines from the log file.
#   Typical examples:  "ascii", "utf-8"
#
#   auto:   will use the system locale setting
logencoding = {{ fail2ban_logencoding|default(fail2ban_default_logencoding) }}

# "enabled" enables the jails.
#  By default all jails are disabled, and it should stay this way.
#  Enable only relevant to your setup jails in your .local or jail.d/*.conf
#
# true:  jail will be enabled and log files will get monitored for changes
# false: jail is not enabled
enabled = {{ fail2ban_enabled|default(fail2ban_default_enabled)|string|lower }}


# "mode" defines the mode of the filter (see corresponding filter implementation for more info).
mode = {{ fail2ban_mode|default(fail2ban_default_mode) }}

# "filter" defines the filter to use by the jail.
#  By default jails have names matching their filter name
#
filter = {{ fail2ban_filter|default(fail2ban_default_filter) }}


#
# ACTIONS
#

# Some options used for actions

# Destination email address used solely for the interpolations in
# jail.{conf,local,d/*} configuration files.
destemail = {{ fail2ban_destemail|default(fail2ban_default_destemail) }}

# Sender email address used solely for some actions
sender = {{ fail2ban_sender|default(fail2ban_default_sender) }}

# E-mail action. Since 0.8.1 Fail2Ban uses sendmail MTA for the
# mailing. Change mta configuration parameter to mail if you want to
# revert to conventional 'mail'.
mta = {{ fail2ban_mta|default(fail2ban_default_mta) }}

# Default protocol
protocol = {{ fail2ban_protocol|default(fail2ban_default_protocol) }}

# Specify chain where jumps would need to be added in ban-actions expecting parameter chain
chain = {{ fail2ban_chain|default(fail2ban_default_chain) }}

# Ports to be banned
# Usually should be overridden in a particular jail
port = {{ fail2ban_port|default(fail2ban_default_port) }}

# Format of user-agent https://tools.ietf.org/html/rfc7231#section-5.5.3
fail2ban_agent = {{ fail2ban_fail2ban_agent|default(fail2ban_default_fail2ban_agent) }}

#
# Action shortcuts. To be used to define action parameter

# Default banning action (e.g. iptables, iptables-new,
# iptables-multiport, shorewall, etc) It is used to define
# action_* variables. Can be overridden globally or per
# section within jail.local file
banaction = {{ fail2ban_banaction|default(fail2ban_default_banaction) }}
banaction_allports = {{ fail2ban_banaction_allports|default(fail2ban_default_banaction_allports) }}

# The simplest action to take: ban only
action_ = {{ fail2ban_action_|default(fail2ban_default_action_) }}

# ban & send an e-mail with whois report to the destemail.
action_mw = {{ fail2ban_action_mw|default(fail2ban_default_action_mw) }}

# ban & send an e-mail with whois report and relevant log lines
# to the destemail.
action_mwl = {{ fail2ban_action_mwl|default(fail2ban_default_action_mwl) }}

# See the IMPORTANT note in action.d/xarf-login-attack for when to use this action
#
# ban & send a xarf e-mail to abuse contact of IP address and include relevant log lines
# to the destemail.
action_xarf = {{ fail2ban_action_xarf|default(fail2ban_default_action_xarf) }}

# ban IP on CloudFlare & send an e-mail with whois report and relevant log lines
# to the destemail.
action_cf_mwl = {{ fail2ban_action_cf_mwl|default(fail2ban_default_action_cf_mwl) }}

# Report block via blocklist.de fail2ban reporting service API
#
# See the IMPORTANT note in action.d/blocklist_de.conf for when to use this action.
# Specify expected parameters in file action.d/blocklist_de.local or if the interpolation
# `action_blocklist_de` used for the action, set value of `blocklist_de_apikey`
# in your `jail.local` globally (section [DEFAULT]) or per specific jail section (resp. in
# corresponding jail.d/my-jail.local file).
#
action_blocklist_de  = {{ fail2ban_action_blocklist_de|default(fail2ban_default_action_blocklist_de) }}

# Report ban via badips.com, and use as blacklist
#
# See BadIPsAction docstring in config/action.d/badips.py for
# documentation for this action.
#
# NOTE: This action relies on banaction being present on start and therefore
# should be last action defined for a jail.
#
action_badips = {{ fail2ban_action_badips|default(fail2ban_default_action_badips) }}
#
# Report ban via badips.com (uses action.d/badips.conf for reporting only)
#
action_badips_report = {{ fail2ban_action_badips_report|default(fail2ban_default_action_badips_report) }}

# Report ban via abuseipdb.com.
#
# See action.d/abuseipdb.conf for usage example and details.
#
action_abuseipdb = {{ fail2ban_action_abuseipdb|default(fail2ban_default_action_abuseipdb) }}

# Choose default action.  To change, just override value of 'action' with the
# interpolation to the chosen action shortcut (e.g.  action_mw, action_mwl, etc) in jail.local
# globally (section [DEFAULT]) or per specific section
action = {{ fail2ban_action|default(fail2ban_default_action) }}

#
# JAILS
#

{% for service in fail2ban_services %}
[{{ service.name }}]
enabled = {{ service.enabled|default(true)|string|lower }}
{% for option, value in service.items() | sort %}
{% if option not in ['name', 'enabled'] %}
{{ option }} = {{ value }}
{% endif %}
{% endfor %}

{% endfor %}